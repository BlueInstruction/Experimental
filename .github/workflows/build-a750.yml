name: Turnip Adreno A750

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-a750:
    runs-on: ubuntu-latest

    env:
      ANDROID_API: "34"
      NDK_VERSION: "r27d"
      MESA_SHADER_CACHE_MAX_SIZE: "2147483648"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            ninja-build \
            pkg-config \
            python3-pip \
            python3-mako \
            meson \
            glslang-tools \
            spirv-tools \
            flex \
            bison \
            unzip \
            curl

      - name: Download Android NDK
        run: |
          curl -L -o ndk.zip https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip
          unzip -q ndk.zip
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-${NDK_VERSION}" >> "$GITHUB_ENV"

      - name: Clone Mesa
        run: |
          git clone --depth 1 https://gitlab.freedesktop.org/mesa/mesa.git mesa

      - name: Apply shader cache change (inline)
        run: |
          set -e
          cd mesa

          FILE="src/util/disk_cache.c"

          sed -i \
            's/return env ? strtoull(env, NULL, 10) : (uint64_t)1 << 30;/if (env \&\& env[0] != '\''\\0'\'') {\n      return strtoull(env, NULL, 10);\n   }\n\n   return (uint64_t)2 << 30;/' \
            "$FILE"

      - name: Create Android cross file
        run: |
          cat > android-aarch64.txt << EOF
          [binaries]
          c = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android${ANDROID_API}-clang'
          cpp = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android${ANDROID_API}-clang++'
          ar = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar'
          strip = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip'

          [host_machine]
          system = 'android'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF

      - name: Build Turnip driver
        run: |
          wget -q https://archive.mesa3d.org/mesa-${{ env.mesa-version }}.tar.xz
          tar -xf mesa-${{ env.mesa-version }}.tar.xz
          cd mesa-${{ env.mesa-version }}

          sed -e "s|NDKDIR|$ANDROID_NDK_LATEST_HOME|g" < ../android-aarch64 > android-aarch64
          patch -p1 -i ../0006-shader-cache-expand.patch
          patch -p1 -i ../mesa-android-include-all-vulkan-extension.patch

          meson setup build-android --cross-file ./android-aarch64 \
            -Dplatforms=android \
            -Dandroid-stub=true \
            -Dvulkan-drivers=freedreno \
            -Dfreedreno-kmds=kgsl \
            -Dgallium-drivers= \
            -Dbuildtype=release \
            -Db_lto=true \
            -Dstrip=true \
            -Dglx=disabled \
            -Degl=disabled \
            -Dgles1=disabled \
            -Dgles2=disabled

          ninja -C build-android

          mkdir -p ../out
          cp build-android/src/freedreno/vulkan/libvulkan_freedreno.so \
            ../out/vulkan.ad07xx.so

      - name: Package driver
        run: |
          cp meta/meta-a750.json out/meta.json
          cd out
          zip -9 turnip-adreno-a750.zip vulkan.ad07xx.so meta.json

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: a750-${{ github.run_number }}
          name: Turnip Adreno A750
          files: out/turnip-adreno-a750.zip
