name: Build Wine Arm64ec 
on:
  workflow_dispatch:
    inputs:
      version_name:
        default: wine-10.0-4-arm64ec
      include_dxvk:
        default: 'true'
        type: choice
        options: ['true', 'false']
      include_vkd3d:
        default: 'true'
        type: choice
        options: ['true', 'false']
env:
  VERSION_NAME: ${{ github.event.inputs.version_name }}
  OUT_DIR: ./out
  TOOLCHAIN_DIR: /opt/llvm-mingw
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt clean
          df -h

      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt update
          sudo apt install -y alsa-tools autoconf automake bison build-essential clang cmake curl flex gettext git glslang-tools jq libasound2-dev libcups2-dev libdbus-1-dev libdrm-dev libfaudio-dev libfontconfig1-dev libfreetype6-dev libgl1-mesa-dev libglu1-mesa-dev libgnutls28-dev libgphoto2-dev libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libjpeg-dev libkrb5-dev liblcms2-dev libldap2-dev libmpg123-dev libopenal-dev libosmesa6-dev libpcap-dev libpng-dev libpulse-dev libsane-dev libsdl2-dev libssl-dev libtiff-dev libtool libudev-dev libunwind-dev libusb-1.0-0-dev libv4l-dev libvulkan-dev libx11-dev libxcb1-dev libxcomposite-dev libxcursor-dev libxext-dev libxfixes-dev libxi-dev libxinerama-dev libxml2-dev libxrandr-dev libxrender-dev libxslt1-dev libxxf86vm-dev lld llvm ninja-build ocl-icd-opencl-dev pkg-config python3 python3-pip wget wine64-tools xz-utils zstd
          sudo pip3 install --upgrade meson
          meson --version
    
      - name: Setup LLVM MinGW toolchain
        run: |
          wget https://github.com/bylaws/llvm-mingw/releases/download/20250920/llvm-mingw-20250920-ucrt-ubuntu-22.04-x86_64.tar.xz -O llvm-mingw.tar.xz
          sudo mkdir -p $TOOLCHAIN_DIR
          sudo tar -C $TOOLCHAIN_DIR --strip-components=1 -xJf llvm-mingw.tar.xz
          echo "$TOOLCHAIN_DIR/bin" >> $GITHUB_PATH

      - name: Verify toolchain
        run: |
          export PATH="$TOOLCHAIN_DIR/bin:$PATH"
          arm64ec-w64-mingw32-clang --version || { echo "arm64ec clang missing"; exit 1; }
          aarch64-w64-mingw32-clang --version || { echo "aarch64 clang missing"; exit 1; }

      - name: Clone FEX with submodules
        run: |
          git clone --recursive https://github.com/FEX-Emu/FEX.git fex-source
          cd fex-source
          git submodule update --init --recursive --depth 1

      - name: Build FEX ARM64EC (x86_64 emulation)
        run: |
          set -e
          export PATH="$TOOLCHAIN_DIR/bin:$PATH"
          cd fex-source
          mkdir build-arm64ec
          cd build-arm64ec
          cmake -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=../Data/CMake/toolchain_mingw.cmake \
            -DCMAKE_INSTALL_LIBDIR=/usr/lib/wine/aarch64-windows \
            -DENABLE_LTO=False \
            -DMINGW_TRIPLE=arm64ec-w64-mingw32 \
            -DBUILD_TESTING=False \
            -DENABLE_JEMALLOC=False \
            -DENABLE_JEMALLOC_GLIBC_ALLOC=False \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DTUNE_CPU=none \
            ..
          ninja
          sudo ninja install

      - name: Build FEX WOW64 (x86 emulation)
        run: |
          set -e
          export PATH="$TOOLCHAIN_DIR/bin:$PATH"
          cd fex-source
          mkdir build-wow64
          cd build-wow64
          cmake -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=../Data/CMake/toolchain_mingw.cmake \
            -DCMAKE_INSTALL_LIBDIR=/usr/lib/wine/aarch64-windows \
            -DENABLE_LTO=False \
            -DMINGW_TRIPLE=aarch64-w64-mingw32 \
            -DBUILD_TESTING=False \
            -DENABLE_JEMALLOC=False \
            -DENABLE_JEMALLOC_GLIBC_ALLOC=False \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DTUNE_CPU=none \
            ..
          ninja
          sudo ninja install

      - name: Clone Wine
        run: |
          git clone --depth 1 -b arm64ec https://github.com/bylaws/wine.git wine-source

      - name: Patch GStreamer compatibility
        run: |
          cd wine-source
          # Fix GstBufferMapInfo -> GstMapInfo in all affected files
          find . -name "*.c" -exec grep -l "GstBufferMapInfo" {} \; 2>/dev/null | while read f; do
            echo "Patching $f"
            sed -i 's/GstBufferMapInfo/GstMapInfo/g' "$f"
          done || true

      - name: Prepare Wine source
        run: |
          set -e
          cd wine-source
          autoreconf -fiv
          tools/make_requests
          tools/make_specfiles
          dlls/winevulkan/make_vulkan

      - name: Build Wine tools
        run: |
          set -e
          mkdir wine-tools
          cd wine-tools
          ../wine-source/configure --enable-win64 --without-x --without-freetype --without-fontconfig --disable-tests
          make -j$(nproc) __tooldeps__
          make -j$(nproc) nls/locale.nls

      - name: Build Wine ARM64EC
        run: |
          set -o pipefail
          export PATH="$TOOLCHAIN_DIR/bin:$PATH"
          mkdir wine-arm64ec
          cd wine-arm64ec
          ../wine-source/configure \
            --enable-archs=arm64ec,aarch64,i386 \
            --with-mingw=clang \
            --with-wine-tools=../wine-tools \
            --without-x \
            --without-freetype \
            --without-fontconfig \
            --without-opencl \
            --disable-tests \
            --prefix="$PWD/install"
          cp ../wine-tools/nls/locale.nls nls/
          if ! make -j$(nproc) 2>&1 | tail -5000 | tee build.log; then
            echo ""
            echo "========== BUILD FAILED - LAST 200 LINES =========="
            tail -200 build.log
            exit 1
          fi
          make install

      - name: Build DXVK
        if: ${{ github.event.inputs.include_dxvk == 'true' }}
        run: |
          set -e
          export PATH="$TOOLCHAIN_DIR/bin:$PATH"
          git clone --depth 1 -b v2.7.1 https://github.com/doitsujin/dxvk.git
          cd dxvk
          git submodule update --init --recursive
          cat > crossfile-arm64ec.txt << 'EOF'
          [binaries]
          ar = 'arm64ec-w64-mingw32-ar'
          c = 'arm64ec-w64-mingw32-clang'
          cpp = 'arm64ec-w64-mingw32-clang++'
          ld = 'arm64ec-w64-mingw32-ld'
          windres = 'arm64ec-w64-mingw32-windres'
          strip = 'arm64ec-w64-mingw32-strip'
          widl = 'arm64ec-w64-mingw32-widl'
          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF
          meson setup build-arm64ec --cross-file crossfile-arm64ec.txt --buildtype release  
          ninja -C build-arm64ec
    
      - name: Build VKD3D-Proton
        if: ${{ github.event.inputs.include_vkd3d == 'true' }}
        run: |
          set -e
          export PATH="$TOOLCHAIN_DIR/bin:$PATH"
          git clone --depth 1 -b v3.0b https://github.com/HansKristian-Work/vkd3d-proton.git
          cd vkd3d-proton
          git submodule update --init --recursive
          cat > crossfile-arm64ec.txt << 'EOF'
          [binaries]
          ar = 'arm64ec-w64-mingw32-ar'
          c = 'arm64ec-w64-mingw32-clang'
          cpp = 'arm64ec-w64-mingw32-clang++'
          ld = 'arm64ec-w64-mingw32-ld'
          windres = 'arm64ec-w64-mingw32-windres'
          strip = 'arm64ec-w64-mingw32-strip'
          widl = 'arm64ec-w64-mingw32-widl'
          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF
          meson setup build-arm64ec --cross-file crossfile-arm64ec.txt --buildtype release
          ninja -C build-arm64ec

      - name: Create Wine prefix pack
        run: |
          set -e
          mkdir -p prefix_temp/.wine/dosdevices
          mkdir -p "prefix_temp/.wine/drive_c/windows/system32"
          mkdir -p "prefix_temp/.wine/drive_c/windows/syswow64"
          mkdir -p "prefix_temp/.wine/drive_c/users/Public/Temp"
          mkdir -p "prefix_temp/.wine/drive_c/Program Files"
          mkdir -p "prefix_temp/.wine/drive_c/Program Files (x86)"
          mkdir -p "prefix_temp/.wine/drive_c/ProgramData"
          
          # Create dosdevices symlinks
          cd prefix_temp/.wine/dosdevices
          ln -s ../drive_c c:
          ln -s /sdcard d:
          ln -s /storage e:
          ln -s / z:
          cd ../../..
          
          # Create registry files
          cat > prefix_temp/.wine/system.reg << 'EOF'
          WINE REGISTRY Version 2
          ;; All keys relative to \\Machine

          [Software\\Microsoft\\Windows NT\\CurrentVersion]
          "CurrentVersion"="10.0"
          "CurrentBuild"="19041"
          "ProductName"="Windows 10 Pro"
          EOF
          
          cat > prefix_temp/.wine/user.reg << 'EOF'
          WINE REGISTRY Version 2
          ;; All keys relative to \\User\\S-1-5-21-0-0-0-1000

          [Software\\Wine\\DllOverrides]
          "*d3d9"="native"
          "*d3d10core"="native"
          "*d3d11"="native"
          "*d3d12"="native"
          "*dxgi"="native"
          EOF
          
          echo 'WINE REGISTRY Version 2' > prefix_temp/.wine/userdef.reg
          date +%s > prefix_temp/.wine/.update-timestamp
          
          # Create archive
          cd prefix_temp
          tar -cJf ../prefixPack.txz .wine
          cd ..
          rm -rf prefix_temp

      - name: Package WCP
        run: |
          set -e
          mkdir -p ${OUT_DIR}
          mkdir -p wcp_package/bin
          mkdir -p wcp_package/lib/wine/aarch64-unix
          mkdir -p wcp_package/lib/wine/aarch64-windows
          mkdir -p wcp_package/lib/wine/i386-windows
          mkdir -p wcp_package/share/wine

          # Copy Wine installation
          cp -r wine-arm64ec/install/* wcp_package/

          # Copy FEX DLLs
          cp /usr/lib/wine/aarch64-windows/*.dll wcp_package/lib/wine/aarch64-windows/ 2>/dev/null || true

          # Copy DXVK DLLs
          if [ "${{ github.event.inputs.include_dxvk }}" = "true" ]; then
            find dxvk/build-arm64ec -name "*.dll" -exec cp {} wcp_package/lib/wine/aarch64-windows/ \; 2>/dev/null || true
          fi

          # Copy VKD3D DLLs
          if [ "${{ github.event.inputs.include_vkd3d }}" = "true" ]; then
            find vkd3d-proton/build-arm64ec -name "*.dll" -exec cp {} wcp_package/lib/wine/aarch64-windows/ \; 2>/dev/null || true
          fi

          # Copy prefix pack
          cp prefixPack.txz wcp_package/

          # Create profile.json (matching Winlator format)
          cat > wcp_package/profile.json << EOF
          {
            "type": "Wine",
            "versionName": "${VERSION_NAME}",
            "versionCode": $(date +%Y%m%d),
            "description": "Wine 10 ARM64EC + FEX for Winlator",
            "files": [],
            "wine": {
              "binPath": "bin",
              "libPath": "lib",
              "prefixPack": "prefixPack.txz"
            }
          }
          EOF

          # Create WCP archive
          cd wcp_package
          tar -cJf "../${OUT_DIR}/${VERSION_NAME}.wcp" .
          cd ..

          # Create checksum
          cd ${OUT_DIR}
          sha256sum "${VERSION_NAME}.wcp" > "${VERSION_NAME}.wcp.sha256"

      - name: Verify package
        run: |
          echo "=== Package contents ==="
          tar -tJf "${OUT_DIR}/${VERSION_NAME}.wcp" | head -50
          echo ""
          echo "=== Verification ==="
          tar -tJf "${OUT_DIR}/${VERSION_NAME}.wcp" | grep -q "profile.json" && echo "✓ profile.json found"
          tar -tJf "${OUT_DIR}/${VERSION_NAME}.wcp" | grep -q "prefixPack.txz" && echo "✓ prefixPack.txz found"
          tar -tJf "${OUT_DIR}/${VERSION_NAME}.wcp" | grep -q "bin/" && echo "✓ bin/ found"
          tar -tJf "${OUT_DIR}/${VERSION_NAME}.wcp" | grep -q "lib/wine" && echo "✓ lib/wine found"
          echo ""
          echo "=== Package size ==="
          ls -lh "${OUT_DIR}/${VERSION_NAME}.wcp"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.VERSION_NAME }}
          path: |
            ./out/*.wcp
            ./out/*.sha256
          if-no-files-found: error
          retention-days: 90

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_number }}
          path: |
            wine-tools/config.log
            wine-arm64ec/config.log
            wine-arm64ec/build.log
            fex-source/build-arm64ec/CMakeFiles/CMakeError.log
            fex-source/build-wow64/CMakeFiles/CMakeError.log
          if-no-files-found: ignore
