name: Build Test

on:
  schedule:
    - cron: "0 21 * * *"
  workflow_dispatch:
    inputs:
      FORCE_MODE:
        type: boolean
        default: false
      VERSION:
        required: false
        default: ""
      BUILD_TYPE:
        type: choice
        default: "release"
        options: ["release", "debug"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: write

defaults:
  run:
    shell: 'bash --noprofile --norc -Eeuo pipefail {0}'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            /var/cache/apt
          key: ${{ runner.os }}-vkd3d-deps-${{ hashFiles('**/workflow.yml') }}
          restore-keys: |
            ${{ runner.os }}-vkd3d-deps-

      - name: Setup Dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y git meson ninja-build curl jq python3 glslang-tools spirv-tools zstd \
            gcc-mingw-w64-x86-64 gcc-mingw-w64-i686 g++-mingw-w64-x86-64 g++-mingw-w64-i686 \
            mingw-w64 mingw-w64-tools binutils-mingw-w64
          sudo update-alternatives --set x86_64-w64-mingw32-gcc /usr/bin/x86_64-w64-mingw32-gcc-posix 2>/dev/null || true
          sudo update-alternatives --set x86_64-w64-mingw32-g++ /usr/bin/x86_64-w64-mingw32-g++-posix 2>/dev/null || true
          sudo update-alternatives --set i686-w64-mingw32-gcc /usr/bin/i686-w64-mingw32-gcc-posix 2>/dev/null || true
          sudo update-alternatives --set i686-w64-mingw32-g++ /usr/bin/i686-w64-mingw32-g++-posix 2>/dev/null || true

      - name: Fetch Version
        run: |
          if [[ -n "${{ inputs.VERSION }}" ]]; then
            VER="${{ inputs.VERSION }}"
            [[ "$VER" =~ ^v ]] || VER="v$VER"
          else
            VER=$(curl -sL https://api.github.com/repos/HansKristian-Work/vkd3d-proton/releases/latest | jq -r '.tag_name // empty')
            [[ -z "$VER" ]] && VER=$(curl -sL https://api.github.com/repos/HansKristian-Work/vkd3d-proton/releases | jq -r '.[0].tag_name')
          fi
          echo "TAG=$VER" >> $GITHUB_ENV
          echo "VER=${VER#v}" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV

      - name: Check Release
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RELEASE_TAG="vkd3d-proton-3.0b-${{ env.BUILD_DATE }}"
          EXISTS=$(gh release view "$RELEASE_TAG" --repo ${{ github.repository }} 2>/dev/null && echo "true" || echo "false")
          [[ "${{ inputs.FORCE_MODE }}" == "true" ]] && EXISTS="false"
          echo "SKIP=$EXISTS" >> $GITHUB_OUTPUT
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV

      - name: Clone Source
        if: steps.check.outputs.SKIP == 'false'
        run: |
          git clone --recurse-submodules --recursive --branch ${{ env.TAG }} --depth 1 \
            https://github.com/HansKristian-Work/vkd3d-proton.git src
          cd src && chmod +x ./package-release.sh
          echo "BUILD_ID=3.0b-${{ env.BUILD_DATE }}" >> $GITHUB_ENV
 
      - name: Apply Patches
        if: steps.check.outputs.SKIP == 'false'
        run: |
          cd src
          
          cat > performance_patch.diff << 'EOF'
          diff --git a/libs/vkd3d/command.c b/libs/vkd3d/command.c
          --- a/libs/vkd3d/command.c
          +++ b/libs/vkd3d/command.c
          @@ -1,1 +1,1 @@
          -    device->use_batch_submission = true;
          +    device->use_batch_submission = false;
          diff --git a/libs/vkd3d/device.c b/libs/vkd3d/device.c
          --- a/libs/vkd3d/device.c
          +++ b/libs/vkd3d/device.c
          @@ -1,1 +1,1 @@
          -    device->use_unified_image_layouts = true;
          +    device->use_unified_image_layouts = false;
          diff --git a/libs/vkd3d/resource.c b/libs/vkd3d/resource.c
          --- a/libs/vkd3d/resource.c
          +++ b/libs/vkd3d/resource.c
          @@ -1,1 +1,1 @@
          -    device->enable_strict_barriers = true;
          +    device->enable_strict_barriers = false;
          EOF
          git apply performance_patch.diff || true
          
          cat > patch.py << 'PYSCRIPT'
          import re, os, sys

          applied = 0
          errors = []

          def patch_file(path, patches):
              global applied, errors
              if not os.path.exists(path):
                  return
              try:
                  with open(path, "r", encoding='utf-8', errors='ignore') as f:
                      c = f.read()
              except Exception as e:
                  errors.append(f"Read error {path}: {e}")
                  return
              orig = c
              for p, r in patches:
                  m = len(re.findall(p, c))
                  if m > 0:
                      c = re.sub(p, r, c)
                      applied += m
              if c != orig:
                  try:
                      with open(path, "w", encoding='utf-8') as f:
                          f.write(c)
                  except Exception as e:
                      errors.append(f"Write error {path}: {e}")

          gpu = [
              (r'(adapter_id\.vendor_id\s*(?<!=)=(?!=)\s*)[^;]+;', r'\g<1>0x1002;'),
              (r'(adapter_id\.device_id\s*(?<!=)=(?!=)\s*)[^;]+;', r'\g<1>0x163f;'),
              (r'(DedicatedVideoMemory\s*(?<!=)=(?!=)\s*)[^;]+;', r'\g<1>1024ULL * 1024 * 1024;'),
              (r'(SharedSystemMemory\s*(?<!=)=(?!=)\s*)[^;]+;', r'\g<1>16384ULL * 1024 * 1024;'),
              (r'(\.UMA\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(\.CacheCoherentUMA\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(\.IsolatedMMU\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
          ]

          dev = [
              # === Shader Model 6.8 min-spec ===
              (r'(data->HighestShaderModel\s*=\s*)[^;]+;', r'\g<1>D3D_SHADER_MODEL_6_8;'),
              (r'(info\.HighestShaderModel\s*=\s*)[^;]+;', r'\g<1>D3D_SHADER_MODEL_6_8;'),
              (r'(MaxSupportedFeatureLevel\s*=\s*)[^;]+;', r'\g<1>D3D_FEATURE_LEVEL_12_2;'),
              (r'(D3D12SDKVersion\s*=\s*)[^;]+;', r'\g<1>618;'),

              # === SV_StartInstanceLocation / SV_StartVertexLocation ===
              (r'(options\.SVStartInstanceLocationSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options\.SVStartVertexLocationSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === WaveSize range ===
              (r'(options1\.WaveOps\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options1\.WaveLaneCountMin\s*=\s*)[^;]+;', r'\g<1>32;'),
              (r'(options1\.WaveLaneCountMax\s*=\s*)[^;]+;', r'\g<1>64;'),
              (r'(options1\.Int64ShaderOps\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options1\.ExpandedComputeResourceStates\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === Vulkan texturing catch-up (esoteric comparison sampling) ===
              (r'(options2\.DepthBoundsTestSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options2\.ProgrammableSamplePositionsTier\s*=\s*)[^;]+;', r'\g<1>D3D12_PROGRAMMABLE_SAMPLE_POSITIONS_TIER_2;'),

              # === Barycentrics ===
              (r'(options3\.BarycentricsSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options3\.ThresholdCoefficientsSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === Native 16-bit & MSAA fixes (Arma Reforger) ===
              (r'(options4\.Native16BitShaderOpsSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options4\.MSAAOperationsSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === Raytracing / Render Passes ===
              (r'(options5\.RaytracingTier\s*=\s*)[^;]+;', r'\g<1>D3D12_RAYTRACING_TIER_1_2;'),
              (r'(options5\.RenderPassesTier\s*=\s*)[^;]+;', r'\g<1>D3D12_RENDER_PASS_TIER_2;'),
              (r'(options5\.SRVOnlyTiledResourceTier3\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === VRS / fix (disable VRS with DS write in shader) ===
              (r'(options6\.VariableShadingRateTier\s*=\s*)[^;]+;', r'\g<1>D3D12_VARIABLE_SHADING_RATE_TIER_2;'),
              (r'(options6\.ShadingRateImageTileSize\s*=\s*)[^;]+;', r'\g<1>8;'),
              (r'(options6\.BackgroundProcessingSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options6\.AdditionalShadingRatesSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options6\.PerPrimitiveShadingRateSupportedWithViewportIndexing\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === Mesh Shaders / Sampler Feedback ===
              (r'(options7\.MeshShaderTier\s*=\s*)[^;]+;', r'\g<1>D3D12_MESH_SHADER_TIER_1;'),
              (r'(options7\.SamplerFeedbackTier\s*=\s*)[^;]+;', r'\g<1>D3D12_SAMPLER_FEEDBACK_TIER_1_0;'),

              # === Unaligned Block Textures ===
              (r'(options8\.UnalignedBlockTexturesSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === Advanced Texture Ops / MSAA Writeable ===
              (r'(options9\.AdvancedTextureOpsSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options9\.WriteableMSAATexturesSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options9\.MeshShaderSupportsFullRangeRenderTargetArrayIndex\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === VRS Sum Combiner / Mesh Shader Per-Primitive ===
              (r'(options10\.VariableRateShadingSumCombinerSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options10\.MeshShaderPerPrimitiveShadingRateSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === Atomic Int64 / Derivatives in Mesh/Amplification ===
              (r'(options11\.AtomicInt64OnDescriptorHeapResourceSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options11\.AtomicInt64OnGroupSharedSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options11\.AtomicInt64OnTypedResourceSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options11\.DerivativesInMeshAndAmplificationShadersSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === Enhanced Barriers / Relaxed Format Casting ===
              (r'(options12\.EnhancedBarriersSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options12\.RelaxedFormatCastingSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options12\.UnifiedImageLayoutsSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options12\.MSPrimitivesPipelineStatisticIncludesCulledPrimitives\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === Unrestricted Copy / Vertex Alignment / Viewport Flips ===
              (r'(options13\.UnrestrictedBufferTextureCopyPitchSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options13\.UnrestrictedVertexElementAlignmentSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options13\.InvertedViewportHeightFlipsYSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options13\.InvertedViewportDepthFlipsZSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options13\.TextureCopyBetweenDimensionsSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options13\.AlphaBlendFactorSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === GPU Upload Heap / ReBAR tweaks (>8GB only) ===
              (r'(options16\.GPUUploadHeapSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options16\.MapDefaultHeapAllocationSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === Non-Normalized Samplers / Manual Write Tracking ===
              (r'(options17\.NonNormalizedCoordinateSamplersSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options17\.ManualWriteTrackingResourceSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === Work Graphs / Execute Indirect / SampleCmpGradientAndBias ===
              (r'(options21\.WorkGraphsTier\s*=\s*)[^;]+;', r'\g<1>D3D12_WORK_GRAPHS_TIER_1_0;'),
              (r'(options21\.ExecuteIndirectTier\s*=\s*)[^;]+;', r'\g<1>D3D12_EXECUTE_INDIRECT_TIER_1_1;'),
              (r'(options21\.SampleCmpGradientAndBiasSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options21\.ExtendedCommandInfoSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === Core options: Resource Binding / Tiling / Heap / ROV ===
              (r'(options\.ResourceBindingTier\s*=\s*)[^;]+;', r'\g<1>D3D12_RESOURCE_BINDING_TIER_3;'),
              (r'(options\.TiledResourcesTier\s*=\s*)[^;]+;', r'\g<1>D3D12_TILED_RESOURCES_TIER_4;'),
              (r'(options\.ResourceHeapTier\s*=\s*)[^;]+;', r'\g<1>D3D12_RESOURCE_HEAP_TIER_2;'),
              (r'(options\.DoublePrecisionFloatShaderOps\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options\.ROVsSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options\.ConservativeRasterizationTier\s*=\s*)[^;]+;', r'\g<1>D3D12_CONSERVATIVE_RASTERIZATION_TIER_3;'),
              (r'(options\.PSSpecifiedStencilRefSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options\.TypedUAVLoadAdditionalFormats\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options\.VPAndRTArrayIndexFromAnyShaderFeedingRasterizerSupportedWithoutGSEmulation\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options\.OutputMergerLogicOp\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === VK_MESA_image_alignment_control (reduces AMD VRAM bloat) ===
              (r'(options\.ImageAlignmentControlSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === Opacity Micromap / Cooperative Matrix / GDeflate ===
              (r'(options\.OpacityMicromapSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options\.CooperativeMatrixSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options\.GDeflateSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === NULL index buffer support (VK_KHR_maintenance6) ===
              (r'(options\.NullIndexBufferSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === Stencil / Triangle Fan / Dynamic features ===
              (r'(options\.IndependentFrontAndBackStencilRefMaskSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options\.TriangleFanSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options\.DynamicIndexBufferStripCutSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options\.DynamicDepthBiasSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === Misc rendering features ===
              (r'(options\.NonNormalizedCoordinateSamplersSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options\.MismatchingOutputDimensionsSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options\.PointSamplingAddressesNeverRoundUp\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options\.RasterizerDesc2Supported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options\.NarrowQuadrilateralLinesSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options\.AnisoFilterWithPointMipSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === NV_low_latency2 / Anti-Lag ===
              (r'(options\.LowLatency2Supported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options\.AntiLagSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === Shared Resource / Depth Bias / Compute Shader Derivatives ===
              (r'(options\.SharedResourceCompatibilityTier\s*=\s*)[^;]+;', r'\g<1>D3D12_SHARED_RESOURCE_COMPATIBILITY_TIER_2;'),
              (r'(options\.DepthBiasControlSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options\.ComputeShaderDerivativesSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === VK_EXT_device_address_binding_report / Destruction Notifier ===
              (r'(options\.DeviceAddressBindingReportSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options\.DestructionNotifierSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === Pageable Device Local Memory / OpenVR-OpenXR Interop ===
              (r'(options\.PageableDeviceLocalMemorySupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options\.VRInteropSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === Shader cache split by .exe name ===
              (r'(options\.PerProcessShaderCacheSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === Wave-ops helper lane fixes (WaveMatch/WaveMultiPrefix) ===
              (r'(options\.WaveOpsHelperLaneFixSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),

              # === Sparse resource workaround (depth-stencil/MSAA sparse for SottR on RADV) ===
              (r'(options\.SparseDepthStencilSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options\.SparseMSAASupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
          ]

          patch_file("libs/vkd3d/device.c", gpu + dev)

          for root, dirs, files in os.walk("libs/vkd3d"):
              for f in files:
                  if not f.endswith((".c", ".h")):
                      continue
                  if f == "device.c":
                      continue
                  path = os.path.join(root, f)
                  if any(k in f for k in ["adapter", "feature", "caps", "d3d12", "device_vkd3d"]):
                      patch_file(path, gpu + dev)

          print(f"Applied {applied} patches")
          if errors:
              print(f"Errors: {len(errors)}")
              for e in errors[:10]:
                  print(f"  {e}")
              sys.exit(1)
          PYSCRIPT
          python3 patch.py
          
      - name: Build
        if: steps.check.outputs.SKIP == 'false'
        run: |
          cd src
          BUILD_FLAGS="-O3 -DNDEBUG -march=x86-64-v2 -fno-math-errno -fno-trapping-math -mno-avx -mno-avx2 -mno-avx512f -mno-fma -mno-f16c -mno-bmi -mno-bmi2 -fno-tree-vectorize"
          if [[ "${{ inputs.BUILD_TYPE }}" == "debug" ]]; then
            BUILD_FLAGS="-O0 -g -DDEBUG -mno-avx -mno-avx2"
          fi
          export CFLAGS="$BUILD_FLAGS"
          export CXXFLAGS="$BUILD_FLAGS"
          export LDFLAGS="-s"
          bash ./package-release.sh ${{ env.TAG }} ../out --no-package 2>&1 | tee build.log
          if [[ ${PIPESTATUS[0]} -ne 0 ]]; then
            echo "Build failed"
            tail -n 100 build.log
            exit 1
          fi
          
      - name: Verify Build
        if: steps.check.outputs.SKIP == 'false'
        run: |
          SRC=$(find out -maxdepth 1 -type d -name "vkd3d-proton-*" | head -1)
          [[ -z "$SRC" ]] && { echo "Build output not found"; exit 1; }
          for a in x64 x86; do
            for d in d3d12.dll d3d12core.dll; do
              DLL="$SRC/$a/$d"
              if [[ ! -f "$DLL" ]]; then
                echo "Missing: $DLL"
                exit 1
              fi
              SIZE=$(stat -c%s "$DLL" 2>/dev/null || stat -f%z "$DLL")
              echo "$DLL: ${SIZE} bytes"
            done
          done
          echo "SRC_PATH=$SRC" >> $GITHUB_ENV

      - name: Create Package
        if: steps.check.outputs.SKIP == 'false'
        run: |
          mkdir -p pkg/system32 pkg/syswow64
          cp "${{ env.SRC_PATH }}/x64/"*.dll pkg/system32/
          cp "${{ env.SRC_PATH }}/x86/"*.dll pkg/syswow64/
          cat > pkg/profile.json << 'JSONEOF'
          {
            "type": "VKD3D",
            "versionName": "3.0b",
            "versionCode": ${{ env.BUILD_DATE }},
            "description": "VKD3D-Proton",
            "files": [
              {"source": "system32/d3d12.dll", "target": "${system32}/d3d12.dll"},
              {"source": "system32/d3d12core.dll", "target": "${system32}/d3d12core.dll"},
              {"source": "syswow64/d3d12.dll", "target": "${syswow64}/d3d12.dll"},
              {"source": "syswow64/d3d12core.dll", "target": "${syswow64}/d3d12core.dll"}
            ]
          }
          JSONEOF
          PKG="vkd3d-proton-3.0b-${{ env.BUILD_DATE }}"
          cd pkg && tar --zstd -cf "../${PKG}.wcp" . && cd ..
          echo "PKG=$PKG" >> $GITHUB_ENV
        
      - name: Upload Artifact
        if: steps.check.outputs.SKIP == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PKG }}
          path: ${{ env.PKG }}.wcp
          retention-days: 30
          compression-level: 9

      - name: Cleanup
        if: always()
        run: |
          rm -rf src out pkg
