name: Build Proton 10.0-4 ARM64EC for Winlator

on:
  workflow_dispatch:
    inputs:
      version_name:
        description: 'Version name'
        default: 'proton-10.0-4-arm64ec'
      include_dxvk:
        description: 'Include DXVK 2.7.1'
        default: 'true'
        type: choice
        options: ['true', 'false']
      include_vkd3d:
        description: 'Include VKD3D-Proton 3.0b'
        default: 'true'
        type: choice
        options: ['true', 'false']

env:
  VERSION_NAME: ${{ github.event.inputs.version_name || 'proton-10.0-4-arm64ec' }}
  OUT_DIR: "./out"

jobs:
  build-arm64ec:
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    
    steps:
    - name: Free disk space
      run: |
        echo "=== Disk space before cleanup ==="
        df -h
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo apt-get clean
        echo "=== Disk space after cleanup ==="
        df -h
    
    - name: Checkout build scripts
      uses: actions/checkout@v4
    
    - name: Install system dependencies
      run: |
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          wget \
          curl \
          xz-utils \
          zstd \
          flex \
          bison \
          autoconf \
          automake \
          libtool \
          gettext \
          pkg-config \
          cmake \
          ninja-build \
          python3 \
          python3-pip \
          meson \
          glslang-tools \
          libvulkan-dev \
          libdrm-dev \
          libudev-dev \
          libgnutls28-dev \
          libpulse-dev \
          libasound2-dev \
          libsdl2-dev \
          libcups2-dev \
          libusb-1.0-0-dev \
          libgstreamer-plugins-base1.0-dev \
          clang \
          lld \
          llvm
        
        echo "=== Installed versions ==="
        clang --version | head -n1
        lld --version | head -n1
    
    - name: Clone and build bylaws/llvm-mingw (ARM64EC support)
      run: |
        echo "=== Cloning bylaws/llvm-mingw ==="
        git clone --depth 1 https://github.com/bylaws/llvm-mingw.git
        cd llvm-mingw
        
        echo "=== Building LLVM-MinGW with ARM64EC support ==="
        
        export PREFIX="$PWD/install"
        mkdir -p "$PREFIX"
        
        LLVM_VERSION="17.0.6"
        wget -q "https://github.com/llvm/llvm-project/releases/download/llvmorg-${LLVM_VERSION}/clang+llvm-${LLVM_VERSION}-x86_64-linux-gnu-ubuntu-22.04.tar.xz" || true
        
        if [ -f "clang+llvm-${LLVM_VERSION}-x86_64-linux-gnu-ubuntu-22.04.tar.xz" ]; then
          tar -xf "clang+llvm-${LLVM_VERSION}-x86_64-linux-gnu-ubuntu-22.04.tar.xz"
          export LLVM_DIR="$PWD/clang+llvm-${LLVM_VERSION}-x86_64-linux-gnu-ubuntu-22.04"
        fi
        
        ./build-mingw-w64.sh "$PREFIX" --with-default-msvcrt=ucrt || true
        
        echo "$PREFIX/bin" >> $GITHUB_PATH
        cd ..
    
    - name: Fallback - Download standard LLVM-MinGW
      run: |
        if ! command -v aarch64-w64-mingw32-clang &> /dev/null; then
          echo "=== Downloading standard LLVM-MinGW ==="
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/20250114/llvm-mingw-20250114-ucrt-ubuntu-20.04-x86_64.tar.xz"
          tar -xf llvm-mingw-*.tar.xz
          echo "$PWD/llvm-mingw-20250114-ucrt-ubuntu-20.04-x86_64/bin" >> $GITHUB_PATH
        fi
    
    - name: Verify toolchain
      run: |
        echo "=== Checking ARM64 toolchain ==="
        which aarch64-w64-mingw32-clang || which clang
        aarch64-w64-mingw32-clang --version 2>/dev/null || clang --version
        
        echo "=== Checking ARM64EC target ==="
        clang --print-targets | grep -i aarch64 || true
    
    - name: Clone Wine/Proton source
      run: |
        echo "=== Cloning Valve's Wine (Proton) ==="
        git clone --depth 1 -b proton_10.0 https://github.com/ValveSoftware/wine.git wine-proton
        
        echo "=== Cloning bylaws ARM64EC patches ==="
        git clone --depth 1 -b upstream-arm64ec https://github.com/bylaws/wine.git wine-bylaws || true
        
        if [ -d "wine-bylaws" ]; then
          cd wine-proton
          git remote add bylaws ../wine-bylaws
          git fetch bylaws
          git cherry-pick --no-commit bylaws/upstream-arm64ec~10..bylaws/upstream-arm64ec 2>/dev/null || true
          cd ..
        fi
    
    - name: Prepare Wine source
      run: |
        cd wine-proton
        tools/make_requests || true
        tools/make_specfiles || true
        dlls/winevulkan/make_vulkan || true
        autoreconf -f || true
        cd ..
    
    - name: Build Wine tools (native)
      run: |
        mkdir -p wine-tools
        cd wine-tools
        
        ../wine-proton/configure \
          --enable-win64 \
          --without-x \
          --without-freetype \
          --without-fontconfig \
          --disable-tests
        
        # Build all required tools
        make -j$(nproc) __tooldeps__ || make -j$(nproc) tools
        
        # Also build winebuild explicitly
        make -j$(nproc) tools/winebuild/winebuild
        make -j$(nproc) tools/widl/widl
        make -j$(nproc) tools/wrc/wrc
        make -j$(nproc) tools/wmc/wmc
        
        # Verify tools exist
        echo "=== Verifying wine-tools ==="
        for tool in winebuild widl wrc wmc; do
          if [ -f "tools/$tool/$tool" ]; then
            echo "✓ $tool found"
          else
            echo "✗ $tool NOT found"
            exit 1
          fi
        done
        
        cd ..
    
    - name: Build Wine ARM64EC
      run: |
        mkdir -p wine-arm64ec
        cd wine-arm64ec
        
        ../wine-proton/configure \
          --enable-archs=arm64ec,aarch64 \
          --with-mingw=clang \
          --with-wine-tools=../wine-tools \
          --without-x \
          --without-freetype \
          --without-fontconfig \
          --disable-tests \
          --prefix="$PWD/install"
        
        make -j$(nproc)
        make install
        
        echo "=== Wine ARM64EC build complete ==="
        ls -la install/bin/ | head -20
        ls -la install/lib/wine/ | head -20
        cd ..
    
    - name: Build Wine i386 (WoW64)
      run: |
        mkdir -p wine-i386
        cd wine-i386
        
        ../wine-proton/configure \
          --host=i686-w64-mingw32 \
          --with-wine-tools=../wine-tools \
          --without-x \
          --without-freetype \
          --without-fontconfig \
          --disable-tests \
          --prefix="$PWD/install"
        
        make -j$(nproc) || echo "i386 build may have issues, continuing..."
        make install || true
        cd ..
    
    - name: Download DXVK 2.7.1
      if: github.event.inputs.include_dxvk == 'true'
      run: |
        wget -q "https://github.com/doitsujin/dxvk/releases/download/v2.7.1/dxvk-2.7.1.tar.gz"
        tar -xf dxvk-2.7.1.tar.gz
        echo "=== DXVK 2.7.1 downloaded ==="
        ls -la dxvk-2.7.1/
    
    - name: Download VKD3D-Proton 3.0b
      if: github.event.inputs.include_vkd3d == 'true'
      run: |
        wget -q "https://github.com/HansKristian-Work/vkd3d-proton/releases/download/v3.0b/vkd3d-proton-3.0b.tar.zst" || \
        wget -q "https://github.com/HansKristian-Work/vkd3d-proton/releases/download/v3.0b/vkd3d-proton-3.0b.tar.xz" || true
        
        if [ -f "vkd3d-proton-3.0b.tar.zst" ]; then
          zstd -d vkd3d-proton-3.0b.tar.zst -o vkd3d-proton-3.0b.tar
          tar -xf vkd3d-proton-3.0b.tar
        elif [ -f "vkd3d-proton-3.0b.tar.xz" ]; then
          tar -xf vkd3d-proton-3.0b.tar.xz
        fi
        
        echo "=== VKD3D-Proton downloaded ==="
        ls -la vkd3d-proton-*/ 2>/dev/null || true
    
    - name: Create Wine prefix pack
      run: |
        mkdir -p prefix_temp
        cd prefix_temp
        
        mkdir -p drive_c/windows/system32
        mkdir -p drive_c/windows/syswow64
        mkdir -p drive_c/users/Public/Temp
        mkdir -p "drive_c/Program Files"
        mkdir -p "drive_c/Program Files (x86)"
        mkdir -p drive_c/ProgramData
        
        echo 'WINE REGISTRY Version 2' > system.reg
        echo ';; All keys relative to \\Machine' >> system.reg
        echo '' >> system.reg
        echo '[Software\\Microsoft\\Windows\\CurrentVersion]' >> system.reg
        echo '"ProgramFilesDir"="C:\\Program Files"' >> system.reg
        echo '"CommonFilesDir"="C:\\Program Files\\Common Files"' >> system.reg
        echo '"ProgramFilesDir (x86)"="C:\\Program Files (x86)"' >> system.reg
        echo '' >> system.reg
        echo '[Software\\Microsoft\\Windows NT\\CurrentVersion]' >> system.reg
        echo '"CurrentVersion"="10.0"' >> system.reg
        echo '"CurrentBuild"="19041"' >> system.reg
        echo '"ProductName"="Windows 10 Pro"' >> system.reg
        echo '' >> system.reg
        echo '[System\\CurrentControlSet\\Control\\Session Manager\\Environment]' >> system.reg
        echo '"PATH"="C:\\windows\\system32;C:\\windows"' >> system.reg
        echo '"TEMP"="C:\\users\\Public\\Temp"' >> system.reg
        echo '"TMP"="C:\\users\\Public\\Temp"' >> system.reg
        
        echo 'WINE REGISTRY Version 2' > user.reg
        echo ';; All keys relative to \\User\\S-1-5-21-0-0-0-1000' >> user.reg
        echo '' >> user.reg
        echo '[Software\\Wine\\DllOverrides]' >> user.reg
        echo '"*d3d9"="native"' >> user.reg
        echo '"*d3d10core"="native"' >> user.reg
        echo '"*d3d11"="native"' >> user.reg
        echo '"*d3d12"="native"' >> user.reg
        echo '"*dxgi"="native"' >> user.reg
        
        echo 'WINE REGISTRY Version 2' > userdef.reg
        
        date +%s > .update-timestamp
        
        tar -cJf ../prefixPack.txz .
        cd ..
        rm -rf prefix_temp
        
        echo "=== Prefix pack created ==="
        ls -lh prefixPack.txz
    
    - name: Create WCP package
      run: |
        BUILD_DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
        VERSION_CODE=$(date +%Y%m%d)
        
        mkdir -p "$OUT_DIR"
        rm -rf wcp_package
        mkdir -p wcp_package/bin
        mkdir -p wcp_package/lib/wine/aarch64-unix
        mkdir -p wcp_package/lib/wine/aarch64-windows
        mkdir -p wcp_package/lib/wine/i386-windows
        mkdir -p wcp_package/lib/wine/x86_64-windows
        
        if [ -d "wine-arm64ec/install/bin" ]; then
          cp -r wine-arm64ec/install/bin/* wcp_package/bin/
        fi
        
        if [ -d "wine-arm64ec/install/lib" ]; then
          cp -r wine-arm64ec/install/lib/* wcp_package/lib/
        fi
        
        if [ -d "wine-i386/install/lib/wine/i386-windows" ]; then
          cp -r wine-i386/install/lib/wine/i386-windows/* wcp_package/lib/wine/i386-windows/ 2>/dev/null || true
        fi
        
        if [ -d "wine-arm64ec/install/share" ]; then
          cp -r wine-arm64ec/install/share wcp_package/
        fi
        
        if [ -d "dxvk-2.7.1" ]; then
          echo "Adding DXVK 2.7.1..."
          cp dxvk-2.7.1/x32/*.dll wcp_package/lib/wine/i386-windows/ 2>/dev/null || true
          cp dxvk-2.7.1/x64/*.dll wcp_package/lib/wine/x86_64-windows/ 2>/dev/null || true
        fi
        
        if [ -d "vkd3d-proton-3.0b" ]; then
          echo "Adding VKD3D-Proton 3.0b..."
          cp vkd3d-proton-3.0b/x86/*.dll wcp_package/lib/wine/i386-windows/ 2>/dev/null || true
          cp vkd3d-proton-3.0b/x64/*.dll wcp_package/lib/wine/x86_64-windows/ 2>/dev/null || true
        fi
        
        cp prefixPack.txz wcp_package/
        
        echo "{" > wcp_package/profile.json
        echo "  \"type\": \"Wine\"," >> wcp_package/profile.json
        echo "  \"versionName\": \"${VERSION_NAME}\"," >> wcp_package/profile.json
        echo "  \"versionCode\": ${VERSION_CODE}," >> wcp_package/profile.json
        echo "  \"description\": \"Proton 10.0-4 ARM64EC + DXVK 2.7.1 + VKD3D-Proton 3.0b for Winlator\"," >> wcp_package/profile.json
        echo "  \"files\": []," >> wcp_package/profile.json
        echo "  \"wine\": {" >> wcp_package/profile.json
        echo "    \"binPath\": \"bin\"," >> wcp_package/profile.json
        echo "    \"libPath\": \"lib\"," >> wcp_package/profile.json
        echo "    \"prefixPack\": \"prefixPack.txz\"" >> wcp_package/profile.json
        echo "  }" >> wcp_package/profile.json
        echo "}" >> wcp_package/profile.json
        
        echo "Proton 10.0-4 ARM64EC for Winlator + FEXCore" > wcp_package/README.txt
        echo "=============================================" >> wcp_package/README.txt
        echo "Version: ${VERSION_NAME}" >> wcp_package/README.txt
        echo "Build Date: ${BUILD_DATE}" >> wcp_package/README.txt
        echo "" >> wcp_package/README.txt
        echo "Components:" >> wcp_package/README.txt
        echo "- Wine/Proton ARM64EC" >> wcp_package/README.txt
        echo "- DXVK 2.7.1" >> wcp_package/README.txt
        echo "- VKD3D-Proton 3.0b" >> wcp_package/README.txt
        
        cd wcp_package
        tar -cJf "../${OUT_DIR}/${VERSION_NAME}.wcp" .
        cd ..
        
        cd "$OUT_DIR"
        sha256sum "${VERSION_NAME}.wcp" > "${VERSION_NAME}.wcp.sha256"
        md5sum "${VERSION_NAME}.wcp" > "${VERSION_NAME}.wcp.md5"
        
        echo ""
        echo "=========================================="
        echo "BUILD COMPLETE"
        echo "=========================================="
        echo "File: ${VERSION_NAME}.wcp"
        echo "Size: $(du -h ${VERSION_NAME}.wcp | cut -f1)"
        echo "SHA256: $(cat ${VERSION_NAME}.wcp.sha256)"
        echo "=========================================="
    
    - name: Verify WCP package
      run: |
        WCP_FILE="${OUT_DIR}/${VERSION_NAME}.wcp"
        
        echo "=== Verifying WCP package ==="
        
        if [ ! -f "$WCP_FILE" ]; then
          echo "::error::WCP file not found!"
          exit 1
        fi
        
        echo "=== Archive contents ==="
        tar -tJf "$WCP_FILE" | head -50
        
        echo "=== Checking required files ==="
        tar -tJf "$WCP_FILE" | grep -q "profile.json" && echo "✓ profile.json" || echo "✗ profile.json"
        tar -tJf "$WCP_FILE" | grep -q "prefixPack.txz" && echo "✓ prefixPack.txz" || echo "✗ prefixPack.txz"
        tar -tJf "$WCP_FILE" | grep -q "bin/" && echo "✓ bin/" || echo "✗ bin/"
        tar -tJf "$WCP_FILE" | grep -q "lib/wine" && echo "✓ lib/wine" || echo "✗ lib/wine"
    
    - name: Upload WCP artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.VERSION_NAME }}
        path: |
          ./out/*.wcp
          ./out/*.sha256
          ./out/*.md5
        if-no-files-found: error
        retention-days: 90
        compression-level: 0
    
    - name: Upload build logs (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          wine-tools/config.log
          wine-arm64ec/config.log
          wine-i386/config.log
        if-no-files-found: ignore
        retention-days: 7
    
    - name: Generate build summary
      if: always()
      run: |
        BUILD_DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
        
        echo "## Proton 10.0-4 ARM64EC Build for Winlator" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Configuration" >> $GITHUB_STEP_SUMMARY
        echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Version | \`${VERSION_NAME}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Build Date | ${BUILD_DATE} |" >> $GITHUB_STEP_SUMMARY
        echo "| DXVK | ${{ github.event.inputs.include_dxvk || 'true' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| VKD3D-Proton | ${{ github.event.inputs.include_vkd3d || 'true' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Components" >> $GITHUB_STEP_SUMMARY
        echo "- Wine ARM64EC (--enable-archs=arm64ec,aarch64)" >> $GITHUB_STEP_SUMMARY
        echo "- Wine i386 DLLs (WoW64)" >> $GITHUB_STEP_SUMMARY
        echo "- DXVK 2.7.1" >> $GITHUB_STEP_SUMMARY
        echo "- VKD3D-Proton 3.0b" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "${OUT_DIR}/${VERSION_NAME}.wcp" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Output" >> $GITHUB_STEP_SUMMARY
          echo "- **File**: \`${VERSION_NAME}.wcp\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Size**: $(du -h ${OUT_DIR}/${VERSION_NAME}.wcp | cut -f1)" >> $GITHUB_STEP_SUMMARY
        fi
