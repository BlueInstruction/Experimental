name: Wine ARM64EC Build

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-wine-arm64ec:
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout Winlator
      uses: actions/checkout@v4

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          cmake \
          ninja-build \
          clang \
          lld \
          llvm \
          pkg-config \
          autoconf \
          automake \
          libtool \
          bison \
          flex \
          gettext \
          libfreetype6-dev \
          libgnutls28-dev \
          libpng-dev \
          libjpeg-dev \
          libtiff-dev \
          libxml2-dev \
          libxslt1-dev \
          libfaudio-dev \
          libgstreamer1.0-dev \
          libgstreamer-plugins-base1.0-dev \
          libmpg123-dev \
          libosmesa6-dev \
          libsdl2-dev \
          libudev-dev \
          libvulkan-dev \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          libx11-dev \
          libxext-dev \
          libxcursor-dev \
          libxi-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxxf86vm-dev \
          libxcomposite-dev \
          libxrender-dev \
          libxfixes-dev \
          libpcap-dev \
          libdbus-1-dev \
          libfontconfig1-dev \
          libcups2-dev \
          libkrb5-dev \
          libpulse-dev \
          libasound2-dev \
          libsane-dev \
          libv4l-dev \
          libgphoto2-dev \
          libusb-1.0-0-dev \
          liblcms2-dev \
          libldap2-dev \
          libunwind-dev \
          libssl-dev \
          meson \
          glslang-tools \
          wine64-tools

    - name: Setup ARM64EC Toolchain
      run: |
        # Download prebuilt ARM64EC toolchain
        wget -q https://github.com/bylaws/llvm-mingw/releases/latest/download/llvm-mingw-aarch64.tar.gz
        tar -xzf llvm-mingw-aarch64.tar.gz
        
        # Get the actual directory name (it includes version number)
        TOOLCHAIN_DIR=$(tar -tzf llvm-mingw-aarch64.tar.gz | head -1 | cut -f1 -d"/")
        
        # Set up toolchain path - MUST BE FIRST in PATH to override system ar
        echo "TOOLCHAIN_PATH=$(pwd)/${TOOLCHAIN_DIR}" >> $GITHUB_ENV
        echo "$(pwd)/${TOOLCHAIN_DIR}/bin" >> $GITHUB_PATH
        
        # Verify toolchain has ARM64EC support
        $(pwd)/${TOOLCHAIN_DIR}/bin/clang --version
        $(pwd)/${TOOLCHAIN_DIR}/bin/clang --print-targets | grep -i arm64ec || echo "Warning: ARM64EC target may not be available"

    - name: Clone Wine with ARM64EC Support
      run: |
        git clone --depth 1 https://gitlab.winehq.org/bylaws/wine.git -b upstream-arm64ec wine-arm64ec-build
        cd wine-arm64ec-build
        echo "WINE_BUILD_DIR=$(pwd)" >> $GITHUB_ENV

    - name: Build Native Wine Tools
      run: |
        cd $WINE_BUILD_DIR
        mkdir -p build-tools
        cd build-tools
        ../configure --enable-win64 --disable-tests
        make -j$(nproc) tools/winebuild/winebuild tools/widl/widl tools/wrc/wrc tools/wmc/wmc
        echo "WINE_TOOLS_DIR=$(pwd)" >> $GITHUB_ENV

    - name: Configure Wine ARM64EC
      run: |
        cd $WINE_BUILD_DIR
        
        # Ensure toolchain is in PATH (critical - must be first)
        export PATH="${TOOLCHAIN_PATH}/bin:$PATH"
        
        # Configure with ARM64EC support
        ./configure \
          --enable-archs=arm64ec,aarch64,i386 \
          --prefix=/usr \
          --with-mingw=clang \
          --disable-tests \
          --with-tools=$WINE_TOOLS_DIR

    - name: Build Wine ARM64EC
      run: |
        cd $WINE_BUILD_DIR
        
        # Ensure toolchain is in PATH
        export PATH="${TOOLCHAIN_PATH}/bin:$PATH"
        
        # Build with verbose output and error capture
        if ! make -j$(nproc) V=1 2>&1 | tee build.log; then
          echo "::error::Wine build failed"
          echo "Last 100 lines of build log:"
          tail -n 100 build.log
          exit 1
        fi

    - name: Install Wine
      run: |
        cd $WINE_BUILD_DIR
        export PATH="${TOOLCHAIN_PATH}/bin:$PATH"
        sudo --preserve-env=PATH make install -j$(nproc)

    - name: Clone FEX-Emu
      run: |
        git clone --depth 1 --recurse-submodules https://github.com/FEX-Emu/FEX.git fex-emu-build
        cd fex-emu-build
        echo "FEX_BUILD_DIR=$(pwd)" >> $GITHUB_ENV

    - name: Build FEX ARM64EC Module
      run: |
        cd $FEX_BUILD_DIR
        export PATH="${TOOLCHAIN_PATH}/bin:$PATH"
        
        mkdir -p build-arm64ec
        cd build-arm64ec
        
        cmake -GNinja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=../Data/CMake/toolchain_mingw.cmake \
          -DCMAKE_INSTALL_LIBDIR=/usr/lib/wine/aarch64-windows \
          -DENABLE_LTO=False \
          -DMINGW_TRIPLE=arm64ec-w64-mingw32 \
          -DBUILD_TESTING=False \
          -DENABLE_JEMALLOC_GLIBC_ALLOC=False \
          -DTUNE_CPU=none \
          -DCMAKE_INSTALL_PREFIX=/usr \
          ..
        
        ninja
        sudo ninja install

    - name: Build FEX WOW64 Module
      run: |
        cd $FEX_BUILD_DIR
        export PATH="${TOOLCHAIN_PATH}/bin:$PATH"
        
        mkdir -p build-wow64
        cd build-wow64
        
        cmake -GNinja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=../Data/CMake/toolchain_mingw.cmake \
          -DCMAKE_INSTALL_LIBDIR=/usr/lib/wine/aarch64-windows \
          -DENABLE_LTO=False \
          -DMINGW_TRIPLE=aarch64-w64-mingw32 \
          -DBUILD_TESTING=False \
          -DENABLE_JEMALLOC_GLIBC_ALLOC=False \
          -DTUNE_CPU=none \
          -DCMAKE_INSTALL_PREFIX=/usr \
          ..
        
        ninja
        sudo ninja install

    - name: Setup DXVK Cross-file
      run: |
        cat > arm64ec-cross.txt << 'EOF'
[binaries]
ar = 'arm64ec-w64-mingw32-ar'
c = 'arm64ec-w64-mingw32-gcc'
cpp = 'arm64ec-w64-mingw32-g++'
ld = 'arm64ec-w64-mingw32-ld'
windres = 'arm64ec-w64-mingw32-windres'
strip = 'strip'
widl = 'arm64ec-w64-mingw32-widl'
pkgconfig = 'aarch64-linux-gnu-pkg-config'

[host_machine]
system = 'windows'
cpu_family = 'aarch64'
cpu = 'aarch64'
endian = 'little'
EOF
        echo "CROSS_FILE=$(pwd)/arm64ec-cross.txt" >> $GITHUB_ENV

    - name: Build DXVK
      run: |
        export PATH="${TOOLCHAIN_PATH}/bin:$PATH"
        
        git clone --depth 1 --branch v2.7.1 https://github.com/doitsujin/dxvk.git dxvk-build
        cd dxvk-build
        
        ./package-release.sh master /usr --no-package --cross-file=$CROSS_FILE

    - name: Build VKD3D-Proton
      run: |
        export PATH="${TOOLCHAIN_PATH}/bin:$PATH"
        
        git clone --depth 1 --branch v3.0b https://github.com/HansKristian-Work/vkd3d-proton.git vkd3d-build
        cd vkd3d-build
        
        ./package-release.sh master /usr --no-package --cross-file=$CROSS_FILE

    - name: Package Build Artifacts
      run: |
        mkdir -p artifacts/wine
        mkdir -p artifacts/fex
        mkdir -p artifacts/dxvk
        mkdir -p artifacts/vkd3d
        
        # Copy Wine
        cp -r /usr/bin/wine* artifacts/wine/ || true
        cp -r /usr/lib/wine artifacts/wine/ || true
        
        # Copy FEX
        find /usr/lib/wine -name "*fex*" -exec cp {} artifacts/fex/ \; || true
        
        # Copy DXVK
        find dxvk-build -name "*.dll" -exec cp {} artifacts/dxvk/ \; || true
        
        # Copy VKD3D
        find vkd3d-build -name "*.dll" -exec cp {} artifacts/vkd3d/ \; || true

    - name: Upload Wine ARM64EC
      uses: actions/upload-artifact@v4
      with:
        name: wine-arm64ec
        path: artifacts/wine/
        retention-days: 30

    - name: Upload FEX Modules
      uses: actions/upload-artifact@v4
      with:
        name: fex-modules
        path: artifacts/fex/
        retention-days: 30

    - name: Upload DXVK
      uses: actions/upload-artifact@v4
      with:
        name: dxvk-arm64ec
        path: artifacts/dxvk/
        retention-days: 30

    - name: Upload VKD3D
      uses: actions/upload-artifact@v4
      with:
        name: vkd3d-arm64ec
        path: artifacts/vkd3d/
        retention-days: 30

    - name: Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          wine-arm64ec-build/build.log
          fex-emu-build/build-*/
        retention-days: 7
