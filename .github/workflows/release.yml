name: Build Turnip v26.0.0-devel8

on:
  workflow_dispatch:
    inputs:
      build_variant:
        description: 'Build Variant'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - regular
          - gmem
          - sysmem
          - a8xx
          - autotuner
          - regular-v8
          - gmem-v8
          - sysmem-v8
      enable_lrz:
        description: 'Enable LRZ'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

env:
  MESA_COMMIT: "e9a83d530cce"
  MESA_VERSION: "26.0.0"
  BUILD_TAG: "devel8"
  NDK_VERSION: "r29"
  API_LEVEL: "34"
  VULKAN_VERSION: "1.4.335"

jobs:
  build-turnip:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        include:
          # ============================================
          # ARMv9 variants (SD 8 Gen 1/2/3, SD 7+ Gen 2/3)
          # Adreno 730, 740, 750, 710, 720
          # ============================================
          - variant: regular
            suffix: ""
            c_args: ""
            arch: "armv9-a+crypto"
            cpu: "armv9-a"
          - variant: gmem
            suffix: "_Gmem"
            c_args: "-DTU_DEFAULT_GMEM=1"
            arch: "armv9-a+crypto"
            cpu: "armv9-a"
          - variant: sysmem
            suffix: "_Sysmem"
            c_args: "-DTU_DEFAULT_SYSMEM=1"
            arch: "armv9-a+crypto"
            cpu: "armv9-a"
          - variant: a8xx
            suffix: "_a8xx"
            c_args: "-DEXPERIMENTAL_A8XX=1"
            arch: "armv9-a+crypto"
            cpu: "armv9-a"
          - variant: autotuner
            suffix: "_Autotuner"
            c_args: ""
            arch: "armv9-a+crypto"
            cpu: "armv9-a"
          
          # ============================================
          # ARMv8 variants (SD 695, SD 6 Gen 1, older)
          # Adreno 619, 642L, 644, etc.
          # ============================================
          - variant: regular-v8
            suffix: "_ARMv8"
            c_args: ""
            arch: "armv8.2-a+crypto"
            cpu: "armv8.2-a"
          - variant: gmem-v8
            suffix: "_Gmem_ARMv8"
            c_args: "-DTU_DEFAULT_GMEM=1"
            arch: "armv8.2-a+crypto"
            cpu: "armv8.2-a"
          - variant: sysmem-v8
            suffix: "_Sysmem_ARMv8"
            c_args: "-DTU_DEFAULT_SYSMEM=1"
            arch: "armv8.2-a+crypto"
            cpu: "armv8.2-a"

    steps:
      - name: Check Build Selection
        id: check
        run: |
          SELECTED="${{ github.event.inputs.build_variant }}"
          CURRENT="${{ matrix.variant }}"
          if [ "$SELECTED" = "all" ] || [ "$SELECTED" = "$CURRENT" ]; then
            echo "run=true" >> $GITHUB_OUTPUT
          else
            echo "run=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.check.outputs.run == 'true'
        uses: actions/checkout@v4

      - name: Install Dependencies
        if: steps.check.outputs.run == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build python3-pip python3-mako \
            flex bison patchelf curl unzip clang lld llvm cmake pkg-config

      - name: Build Glslang
        if: steps.check.outputs.run == 'true'
        run: |
          git clone --depth 1 --branch 15.1.0 https://github.com/KhronosGroup/glslang.git
          cmake -S glslang -B glslang/build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=$HOME/glslang \
            -DENABLE_OPT=0
          cmake --build glslang/build -j$(nproc)
          cmake --install glslang/build
          echo "$HOME/glslang/bin" >> $GITHUB_PATH

      - name: Setup Meson
        if: steps.check.outputs.run == 'true'
        run: pip3 install --upgrade meson

      - name: Setup NDK
        if: steps.check.outputs.run == 'true'
        run: |
          curl -sL -o ndk.zip "https://dl.google.com/android/repository/android-ndk-${{ env.NDK_VERSION }}-linux.zip"
          unzip -q ndk.zip
          echo "NDK=$PWD/android-ndk-${{ env.NDK_VERSION }}" >> $GITHUB_ENV

      - name: Clone Mesa
        if: steps.check.outputs.run == 'true'
        run: |
          git clone --depth 100 https://gitlab.freedesktop.org/mesa/mesa.git
          cd mesa && git checkout ${{ env.MESA_COMMIT }}

      - name: Apply a8xx Patches
        if: steps.check.outputs.run == 'true' && matrix.variant == 'a8xx'
        run: |
          cd mesa
          git remote add robclark https://gitlab.freedesktop.org/robclark/mesa.git
          git fetch robclark tu/gen8
          git merge --no-commit --no-ff FETCH_HEAD || true

      - name: Configure
        if: steps.check.outputs.run == 'true'
        run: |
          cd mesa
          
          cat > cross.ini << EOF
          [binaries]
          c = ['aarch64-linux-android${{ env.API_LEVEL }}-clang']
          cpp = ['aarch64-linux-android${{ env.API_LEVEL }}-clang++']
          ar = ['llvm-ar']
          strip = ['llvm-strip']
          ld = ['lld']
          
          [host_machine]
          system = 'android'
          cpu_family = 'aarch64'
          cpu = '${{ matrix.cpu }}'
          endian = 'little'
          EOF
          
          export PATH="$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          SYSROOT="$NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          
          meson setup build --cross-file cross.ini \
            -Dplatforms=android \
            -Dplatform-sdk-version=${{ env.API_LEVEL }} \
            -Dandroid-stub=true \
            -Dvulkan-drivers=freedreno \
            -Dfreedreno-kmds=kgsl \
            -Dbuildtype=release \
            -Dstrip=true \
            -Dgallium-drivers= \
            -Dopengl=false \
            -Degl=disabled \
            -Dshader-cache=disabled \
            -Dc_args="-I$SYSROOT/usr/include -O3 -march=${{ matrix.arch }} -g0 ${{ matrix.c_args }}" \
            -Dcpp_args="-I$SYSROOT/usr/include -O3 -march=${{ matrix.arch }} -g0 ${{ matrix.c_args }}" \
            -Dc_link_args="-L$SYSROOT/usr/lib/aarch64-linux-android/${{ env.API_LEVEL }} -lz" \
            -Dcpp_link_args="-L$SYSROOT/usr/lib/aarch64-linux-android/${{ env.API_LEVEL }} -lz"

      - name: Build
        if: steps.check.outputs.run == 'true'
        run: |
          export PATH="$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          ninja -C mesa/build src/freedreno/vulkan/libvulkan_freedreno.so

      - name: Package
        if: steps.check.outputs.run == 'true'
        run: |
          mkdir -p release/out/lib64
          cp mesa/build/src/freedreno/vulkan/libvulkan_freedreno.so release/out/lib64/vulkan.adreno.so
          
          LRZ="${{ github.event.inputs.enable_lrz }}"
          TU_DEBUG=""
          [ "$LRZ" = "false" ] && TU_DEBUG="nolrz"
          
          VARIANT="${{ matrix.variant }}"
          [[ "$VARIANT" == *"gmem"* ]] && TU_DEBUG="${TU_DEBUG:+$TU_DEBUG,}gmem"
          [[ "$VARIANT" == *"sysmem"* ]] && TU_DEBUG="${TU_DEBUG:+$TU_DEBUG,}sysmem"
          
          # Determine architecture label
          if [[ "${{ matrix.arch }}" == *"armv9"* ]]; then
            ARCH_LABEL="ARMv9"
            SUPPORTED_DEVICES="SD 8 Gen 1/2/3, SD 7+ Gen 2/3 (Adreno 730/740/750/710/720)"
          else
            ARCH_LABEL="ARMv8"
            SUPPORTED_DEVICES="SD 695, SD 6 Gen 1 (Adreno 619/642L/644)"
          fi
          
          cat > release/out/meta.json << EOF
          {
            "schemaVersion": 1,
            "name": "Turnip v${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}${{ matrix.suffix }}",
            "packageVersion": "${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}",
            "driverVersion": "${{ env.MESA_VERSION }}",
            "vulkanVersion": "${{ env.VULKAN_VERSION }}",
            "minApi": ${{ env.API_LEVEL }},
            "libraryName": "vulkan.adreno.so",
            "tuDebug": "$TU_DEBUG",
            "baseCommit": "${{ env.MESA_COMMIT }}",
            "architecture": "$ARCH_LABEL",
            "march": "${{ matrix.arch }}",
            "supportedDevices": "$SUPPORTED_DEVICES"
          }
          EOF
          
          cd release/out && zip -r ../Turnip_v${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}${{ matrix.suffix }}.zip .

      - name: Upload
        if: steps.check.outputs.run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: turnip-${{ matrix.variant }}
          path: release/Turnip_v${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}${{ matrix.suffix }}.zip
          retention-days: 5

  release:
    needs: build-turnip
    runs-on: ubuntu-24.04
    if: github.event.inputs.build_variant == 'all'
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Checksums
        run: |
          cd dist
          sha256sum *.zip > SHA256SUMS.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}
          name: "Turnip v${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}"
          body: |
            ## Turnip v${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}
            
            - **Vulkan:** ${{ env.VULKAN_VERSION }}
            - **Base Commit:** ${{ env.MESA_COMMIT }}
            - **NDK:** ${{ env.NDK_VERSION }}
            - **API Level:** ${{ env.API_LEVEL }}
            
            ---
            
            ### üì¶ ARMv9 Builds (Recommended for newer devices)
            **Supported:** SD 8 Gen 1/2/3, SD 7+ Gen 2/3
            **Adreno:** 730, 740, 750, 710, 720
            
            | File | Description |
            |------|-------------|
            | `Turnip_v${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}.zip` | Standard |
            | `Turnip_v${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}_Gmem.zip` | Gmem (a710/720 Winlator) |
            | `Turnip_v${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}_Sysmem.zip` | Sysmem mode |
            | `Turnip_v${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}_a8xx.zip` | a8xx Experimental (a830/a840) |
            | `Turnip_v${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}_Autotuner.zip` | Autotuner |
            
            ---
            
            ### üì¶ ARMv8 Builds (For older devices)
            **Supported:** SD 695, SD 6 Gen 1, older chips
            **Adreno:** 619, 642L, 644
            
            | File | Description |
            |------|-------------|
            | `Turnip_v${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}_ARMv8.zip` | Standard |
            | `Turnip_v${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}_Gmem_ARMv8.zip` | Gmem |
            | `Turnip_v${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}_Sysmem_ARMv8.zip` | Sysmem |
            
            ---
            
            ### ‚ö†Ô∏è Notes
            - **a8xx:** Experimental - use at your own risk!
            - **ONE UI bug:** Set `FD_DEV_FEATURES=enable_tp_ubwc_flag_hint=1`
            - **LRZ issues:** Use `TU_DEBUG=nolrz`
            - **a710/720 on Winlator:** Uncheck sysmem, check gmem in TU_DEBUG
            
          files: |
            dist/*.zip
            dist/SHA256SUMS.txt
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
