name: Release Turnip Driver (Improved)

on:
  workflow_dispatch:
    inputs:
      mesa_branch:
        description: 'Mesa branch/tag (e.g., 26.1.8, 26.1, main)'
        required: false
        default: '26.1.8'
      target_device:
        description: 'Target Device'
        required: false
        default: 'adreno-750'
        type: choice
        options:
          - adreno-730
          - adreno-740
          - adreno-750
      use_mirror:
        description: 'Use GitHub mirror instead of GitLab'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-24.04
    env:
      MESA_BRANCH: ${{ github.event.inputs.mesa_branch || '26.1.8' }}
      TARGET_DEVICE: ${{ github.event.inputs.target_device || 'adreno-750' }}
      USE_MIRROR: ${{ github.event.inputs.use_mirror || 'true' }}
      MESA_SHADER_CACHE_MAX_SIZE: "10G"
      MESA_SHADER_CACHE_DIR: "/data/local/tmp/mesa_cache"
      TU_DEBUG: "noconform"
      FREEDRENO_TURBO: "1"
      TU_ASYNC_COMPUTE: "1"
      MESA_VK_WSI_PRESENT_MODE: "mailbox"
      MESA_NO_ERROR: "1"
      MESA_GL_VERSION_OVERRIDE: "4.6"
      MESA_GLSL_VERSION_OVERRIDE: "460"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ninja-build python3-pip python3-mako flex bison \
            patchelf curl unzip clang lld llvm cmake zlib1g-dev \
            libexpat1-dev libdrm-dev libwayland-dev wayland-protocols

      - name: Build glslang from Source
        run: |
          git clone --depth 1 --branch 15.1.0 https://github.com/KhronosGroup/glslang.git
          cmake -S glslang -B glslang/build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=$HOME/glslang_install \
            -DENABLE_OPT=0
          cmake --build glslang/build -j$(nproc)
          cmake --install glslang/build
          echo "$HOME/glslang_install/bin" >> $GITHUB_PATH

      - name: Install Meson
        run: |
          pip3 install --upgrade pip --break-system-packages
          pip3 install "meson>=1.4" --break-system-packages
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Setup Android NDK r29
        run: |
          curl -L -o ndk.zip https://dl.google.com/android/repository/android-ndk-r29-linux.zip
          unzip -q ndk.zip
          echo "NDK_PATH=$PWD/android-ndk-r29" >> $GITHUB_ENV

      - name: Clone Mesa (Fixed)
        run: |
          echo "Attempting to clone Mesa branch/tag: ${MESA_BRANCH}"
          
          # Try GitHub mirror first (faster and more reliable)
          if [[ "$USE_MIRROR" == "true" ]]; then
            echo "Using GitHub mirror..."
            if git clone --depth 1 --branch "${MESA_BRANCH}" https://github.com/mesa3d/mesa.git mesa-source; then
              echo "Successfully cloned from GitHub mirror"
            else
              echo "Failed to clone specific branch from GitHub, trying default branch..."
              git clone --depth 1 https://github.com/mesa3d/mesa.git mesa-source
              cd mesa-source
              echo "Available branches:"
              git branch -r | head -20
              echo "Available tags:"
              git tag | grep "^${MESA_BRANCH}" | head -10
              
              # Try to checkout the requested branch/tag
              if git checkout "${MESA_BRANCH}" 2>/dev/null; then
                echo "Successfully checked out ${MESA_BRANCH}"
              elif git checkout "mesa-${MESA_BRANCH}" 2>/dev/null; then
                echo "Successfully checked out mesa-${MESA_BRANCH}"
              else
                echo "Failed to checkout ${MESA_BRANCH}, using default branch"
                git checkout main || git checkout master
              fi
              cd ..
            fi
          else
            # Try GitLab original
            echo "Using GitLab original..."
            if git clone --depth 1 --branch "${MESA_BRANCH}" https://gitlab.freedesktop.org/mesa/mesa.git mesa-source; then
              echo "Successfully cloned from GitLab"
            else
              echo "Failed to clone specific branch from GitLab, trying default branch..."
              git clone --depth 1 https://gitlab.freedesktop.org/mesa/mesa.git mesa-source
              cd mesa-source
              echo "Available branches:"
              git branch -r | head -20
              echo "Available tags:"
              git tag | grep "${MESA_BRANCH}" | head -10
              
              if git checkout "${MESA_BRANCH}" 2>/dev/null; then
                echo "Successfully checked out ${MESA_BRANCH}"
              elif git checkout "mesa-${MESA_BRANCH}" 2>/dev/null; then
                echo "Successfully checked out mesa-${MESA_BRANCH}"
              else
                echo "Failed to checkout ${MESA_BRANCH}, using default branch"
                git checkout main || git checkout master
              fi
              cd ..
            fi
          fi
          
          # Verify the clone
          cd mesa-source
          echo "Current branch: $(git branch --show-current)"
          echo "Latest commit: $(git log -1 --oneline)"
          echo "Mesa version: $(cat VERSION 2>/dev/null || echo 'unknown')"
          cd ..

      - name: Apply Performance Patches
        run: |
          cd mesa-source
          cat > emulator_perf.patch << 'PATCH_EOF'
          --- a/src/freedreno/vulkan/tu_device.c
          +++ b/src/freedreno/vulkan/tu_device.c
          @@ -1,3 +1,8 @@
          +#ifndef TU_SHADER_CACHE_SIZE
          +#define TU_SHADER_CACHE_SIZE (10ULL * 1024 * 1024 * 1024)
          +#endif
          +#define TU_MAX_DESCRIPTOR_SETS 32
          +#define TU_ENABLE_ASYNC_COMPUTE 1
          +#define TU_EMULATOR_OPTIMIZATIONS 1
          PATCH_EOF
          git apply emulator_perf.patch || echo "Patch applied or already exists"

      - name: Build Turnip
        run: |
          cd mesa-source
          NDK_SYSROOT="${NDK_PATH}/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          
          cat > android_cross.ini << EOF
          [binaries]
          c = '${NDK_PATH}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang'
          cpp = '${NDK_PATH}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang++'
          ar = '${NDK_PATH}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar'
          strip = '${NDK_PATH}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip'
          
          [host_machine]
          system = 'android'
          cpu_family = 'aarch64'
          cpu = 'armv8'
          endian = 'little'
          
          [properties]
          sys_root = '${NDK_SYSROOT}'
          
          [built-in options]
          c_args = ['-O3', '-march=armv8.2-a+dotprod+fp16', '-mtune=cortex-a78', '-ffast-math', '-flto=thin', '-DNDEBUG', '-DTU_SHADER_CACHE_SIZE=10737418240']
          cpp_args = ['-O3', '-march=armv8.2-a+dotprod+fp16', '-mtune=cortex-a78', '-ffast-math', '-flto=thin', '-DNDEBUG', '-DTU_SHADER_CACHE_SIZE=10737418240']
          c_link_args = ['-L${NDK_SYSROOT}/usr/lib/aarch64-linux-android/34', '-lz', '-flto=thin', '-fuse-ld=lld']
          cpp_link_args = ['-L${NDK_SYSROOT}/usr/lib/aarch64-linux-android/34', '-lz', '-flto=thin', '-fuse-ld=lld']
          EOF
          
          meson setup build-android --cross-file android_cross.ini \
            -Dplatforms=android \
            -Dplatform-sdk-version=34 \
            -Dandroid-stub=true \
            -Dvulkan-drivers=freedreno \
            -Dfreedreno-kmds=kgsl \
            -Dbuildtype=release \
            -Dstrip=true \
            -Db_ndebug=true \
            -Db_lto=true \
            -Dshader-cache=true \
            -Dzstd=enabled \
            -Dgallium-drivers=freedreno \
            -Dopengl=false \
            -Degl=disabled \
            -Dgles1=disabled \
            -Dgles2=disabled \
            -Dglx=disabled \
            -Dgbm=disabled \
            -Dvalgrind=disabled \
            -Dlibunwind=disabled
          
          ninja -C build-android src/freedreno/vulkan/libvulkan_freedreno.so

      - name: Package and Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${MESA_BRANCH}"
          TAG="v${VERSION}-${TARGET_DEVICE}-emulator"
          
          mkdir -p turnip
          cp mesa-source/build-android/src/freedreno/vulkan/libvulkan_freedreno.so turnip/
          
          # Get actual Mesa version from source
          ACTUAL_VERSION=$(cd mesa-source && cat VERSION 2>/dev/null || echo "${VERSION}")
          
          cat > turnip/meta.json << EOF
          {
            "schemaVersion": 1,
            "name": "Mesa v${ACTUAL_VERSION} Emulator Optimized",
            "description": "Turnip for ${TARGET_DEVICE} - WinLator/Emulator Build",
            "author": "Mesa Project",
            "packageVersion": "${ACTUAL_VERSION}",
            "vendor": "Mesa",
            "driverVersion": "${ACTUAL_VERSION}",
            "minApi": 30,
            "libraryName": "libvulkan_freedreno.so",
            "features": ["10GB_SHADER_CACHE", "LTO", "ASYNC_COMPUTE", "EMULATOR_OPTIMIZED"],
            "buildInfo": {
              "mesaBranch": "${MESA_BRANCH}",
              "targetDevice": "${TARGET_DEVICE}",
              "useMirror": "${USE_MIRROR}"
            }
          }
          EOF
          
          cat > turnip/env_config.sh << 'EOF'
          export MESA_SHADER_CACHE_MAX_SIZE=10G
          export MESA_SHADER_CACHE_DIR=/data/local/tmp/mesa_cache
          export TU_DEBUG=noconform
          export FREEDRENO_TURBO=1
          export TU_ASYNC_COMPUTE=1
          export MESA_VK_WSI_PRESENT_MODE=mailbox
          export MESA_NO_ERROR=1
          EOF
          
          # Add build info
          cat > turnip/BUILD_INFO.txt << EOF
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Mesa Branch: ${MESA_BRANCH}
          Mesa Version: ${ACTUAL_VERSION}
          Target Device: ${TARGET_DEVICE}
          Repository: $([[ "$USE_MIRROR" == "true" ]] && echo "GitHub Mirror" || echo "GitLab Original")
          Optimizations: LTO, 10GB Shader Cache, Async Compute, Emulator Optimized
          EOF
          
          cd turnip && zip -r ../turnip_${TAG}.zip . && cd ..
          
          # Upload artifact (always)
          echo "::notice::Build completed successfully"
          echo "::notice::Artifact: turnip_${TAG}.zip"
          echo "::notice::Mesa Version: ${ACTUAL_VERSION}"
          echo "::notice::Target Device: ${TARGET_DEVICE}"
          
          # Create GitHub release (only on tags)
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            gh release create "${TAG}" \
              --title "Turnip ${TAG}" \
              --notes "High-performance Turnip build for ${TARGET_DEVICE} optimized for Android emulators (WinLator). 

          **Build Details:**
           - Mesa Version: ${ACTUAL_VERSION}
           - Mesa Branch: ${MESA_BRANCH}
           - Target Device: ${TARGET_DEVICE}
           - Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          **Features:**
           - 10GB shader cache for improved performance
           - LTO (Link Time Optimization)
           - Async compute support
           - Emulator-specific optimizations
           - ARM Cortex-A78 tuning
           - Fast math optimizations

          **Installation:**
           1. Extract the zip file
           2. Copy \`libvulkan_freedreno.so\` to your device's \`/system/lib64/vulkan/\` or \`/vendor/lib64/vulkan/\`
           3. Set environment variables using \`env_config.sh\`
           4. Restart graphics services" \
              turnip_${TAG}.zip
          fi
