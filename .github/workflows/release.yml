name: Build Turnip Driver for Android Emulator

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-24.04
    
    env:
      MESA_VERSION: "26.0.0"
      ANDROID_NDK_VERSION: "r27"
      ANDROID_API_LEVEL: "34"
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            meson ninja-build python3-pip python3-mako \
            libdrm-dev libxcb1-dev libx11-xcb-dev libxshmfence-dev \
            libxxf86vm-dev libxrandr-dev zlib1g-dev libexpat1-dev \
            libwayland-dev wayland-protocols libwayland-egl-backend-dev \
            glslang-tools spirv-tools llvm clang lld \
            flex bison pkg-config cmake git wget unzip

      - name: Setup Android NDK
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-${{ env.ANDROID_NDK_VERSION }}-linux.zip
          unzip -q android-ndk-${{ env.ANDROID_NDK_VERSION }}-linux.zip
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-${{ env.ANDROID_NDK_VERSION }}" >> $GITHUB_ENV

      - name: Clone Mesa source
        run: |
          git clone --depth 1 --branch mesa-${{ env.MESA_VERSION }} \
            https://gitlab.freedesktop.org/mesa/mesa.git mesa-source

      - name: Create cross-compilation file
        run: |
          cat > android_cross.ini << 'EOF'
          [binaries]
          c = 'aarch64-linux-android${{ env.ANDROID_API_LEVEL }}-clang'
          cpp = 'aarch64-linux-android${{ env.ANDROID_API_LEVEL }}-clang++'
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          pkgconfig = 'pkg-config'

          [host_machine]
          system = 'android'
          cpu_family = 'aarch64'
          cpu = 'armv8'
          endian = 'little'

          [built-in options]
          c_args = ['-march=armv8.2-a', '-O3', '-flto=thin', '-fuse-ld=lld', '-DTU_SHADER_CACHE_SIZE=536870912']
          cpp_args = ['-march=armv8.2-a', '-O3', '-flto=thin', '-fuse-ld=lld', '-DTU_SHADER_CACHE_SIZE=536870912']
          c_link_args = ['-fuse-ld=lld', '-flto=thin']
          cpp_link_args = ['-fuse-ld=lld', '-flto=thin']
          EOF

      - name: Build Mesa Turnip
        run: |
          export PATH="${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          
          cd mesa-source
          meson setup build-android \
            --cross-file ../android_cross.ini \
            --prefix=/usr \
            -Dplatforms= \
            -Dplatform-sdk-version=${{ env.ANDROID_API_LEVEL }} \
            -Dandroid-stub=true \
            -Dgallium-drivers= \
            -Dvulkan-drivers=freedreno \
            -Dfreedreno-kmds=kgsl \
            -Dbuildtype=release \
            -Db_lto=true \
            -Db_ndebug=true \
            -Dcpp_rtti=false \
            -Dshader-cache=enabled \
            -Dshader-cache-default=true
          
          ninja -C build-android

      - name: Package artifacts
        run: |
          mkdir -p release
          cp mesa-source/build-android/src/freedreno/vulkan/libvulkan_freedreno.so release/
          
          cat > release/env_config.sh << 'EOF'
          export MESA_VK_WSI_PRESENT_MODE=fifo
          export TU_DEBUG=noconform
          export MESA_SHADER_CACHE_MAX_SIZE=512M
          export MESA_GLSL_CACHE_DISABLE=0
          EOF
          
          echo "Mesa 26.0.0 Turnip - Emulator Optimized Build" > release/README.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: turnip-adreno-750-emulator-v26.0.0
          path: release/

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          tag_name: v26.0.0-adreno-750-emulator
