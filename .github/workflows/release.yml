name: Turnip Driver (YML Only)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04

    env:
      API: 34

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            meson ninja pkg-config \
            python3-pip python3-mako \
            flex bison \
            glslang-tools spirv-tools \
            unzip curl git

      - name: Install latest Meson
        run: |
          pip3 install --user --upgrade meson mako
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Download Android NDK r26d
        run: |
          curl -L -o ndk.zip https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          unzip -q ndk.zip
          echo "NDK=$PWD/android-ndk-r26d" >> $GITHUB_ENV

      - name: Create Android cross file
        run: |
          cat > android-aarch64.txt << EOF
          [binaries]
          c = '$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android${API}-clang'
          cpp = '$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android${API}-clang++'
          ar = '$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar'
          strip = '$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip'

          [host_machine]
          system = 'android'
          cpu_family = 'aarch64'
          cpu = 'armv8'
          endian = 'little'
          EOF

      - name: Clone Mesa
        run: |
          git clone --depth 1 https://gitlab.freedesktop.org/mesa/mesa.git mesa
          cd mesa
          echo "COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      # ===== INLINE PATCHES =====
      - name: Apply inline patches
        run: |
          cd mesa

          cat << 'EOF' > prefer_sysmem.patch
          diff --git a/src/freedreno/vulkan/tu_device.c b/src/freedreno/vulkan/tu_device.c
          @@ -123,6 +123,7 @@
             device->use_sysmem = true;
          EOF

          git apply prefer_sysmem.patch || echo "sysmem patch skipped"

      - name: Configure Mesa (Winlator-like build)
        run: |
          cd mesa
          meson setup build-android \
            --cross-file ../android-aarch64.txt \
            -Dplatforms=android \
            -Dplatform-sdk-version=${API} \
            -Dandroid-stub=true \
            -Dvulkan-drivers=freedreno \
            -Dfreedreno-kmds=kgsl \
            -Dgallium-drivers= \
            -Dbuildtype=release \
            -Db_lto=false \
            -Dstrip=false \
            -Ddebug=true \
            -Dglx=disabled \
            -Degl=disabled \
            -Dgles1=disabled \
            -Dgles2=disabled \
            -Dopengl=false

      - name: Build Turnip
        run: |
          ninja -C mesa/build-android
          cp mesa/build-android/src/freedreno/vulkan/libvulkan_freedreno.so \
             vulkan.ad07xx.so

      - name: Create meta.json
        run: |
          cat > meta.json << EOF
          {
            "schemaVersion": 1,
            "name": "Turnip Driver (YML only)",
            "author": "Sea Nasr",
            "vendor": "Mesa",
            "driverVersion": "Mesa main (${COMMIT})",
            "minApi": 27,
            "libraryName": "vulkan.ad07xx.so"
          }
          EOF

      - name: Package
        run: |
          zip -9 turnip-yml-only.zip vulkan.ad07xx.so meta.json
          ls -lh vulkan.ad07xx.so

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: turnip-yml-${{ env.COMMIT }}
          name: Turnip YML Only Build
          files: turnip-yml-only.zip
