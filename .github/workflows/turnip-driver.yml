name: Turnip Driver Builder

on:
  workflow_dispatch:
    inputs:
      mesa_source:
        type: choice
        description: "Mesa source"
        default: "main_branch"
        options:
          - latest_release
          - staging_branch
          - main_branch
          - custom_tag
      
      staging_branch:
        type: choice
        description: "Staging branch"
        default: "staging/26.0"
        options:
          - staging/26.0
          - staging/25.3
      
      custom_tag:
        description: "Custom tag"
        required: false
        default: ""
      
      build_type:
        type: choice
        description: "Build type"
        default: "release"
        options:
          - release
          - debug
      
      build_variant:
        type: choice
        description: "Build variant"
        default: "optimized"
        options:
          - optimized
          - autotuner
          - vanilla
          
  schedule:  
    - cron: "0 7 * * 0"

permissions:
  contents: write

env:
  NDK_VERSION: "android-ndk-r28"
  API_LEVEL: "36"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git curl unzip zip \
            python3 python3-pip python3-mako \
            ninja-build ccache patchelf \
            flex bison \
            glslang-tools
          pip install --break-system-packages meson mako pyyaml

      - name: Cache NDK
        id: cache-ndk
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/android-ndk
          key: ${{ env.NDK_VERSION }}

      - name: Setup NDK
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          curl -sL "https://dl.google.com/android/repository/${{ env.NDK_VERSION }}-linux.zip" -o ndk.zip
          unzip -q ndk.zip
          mv ${{ env.NDK_VERSION }} android-ndk

      - name: Build turnip driver
        id: build
        run: |
          chmod +x turnip-driver.sh
          export MESA_SOURCE="${{ inputs.mesa_source || 'main_branch' }}"
          export STAGING_BRANCH="${{ inputs.staging_branch || 'staging/26.0' }}"
          export CUSTOM_TAG="${{ inputs.custom_tag || '' }}"
          export BUILD_TYPE="${{ inputs.build_type || 'release' }}"
          export BUILD_VARIANT="${{ inputs.build_variant || 'optimized' }}"
          export NDK_PATH="${{ github.workspace }}/android-ndk"
          export API_LEVEL="${{ env.API_LEVEL }}"
          
          bash turnip-driver.sh
          
          echo "version=$(cat build/version.txt)" >> $GITHUB_OUTPUT
          echo "filename=$(cat build/filename.txt)" >> $GITHUB_OUTPUT
          echo "vulkan_version=$(cat build/vulkan_version.txt)" >> $GITHUB_OUTPUT
          echo "build_date=$(cat build/build_date.txt)" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.filename }}
          path: build/*.zip
          retention-days: 30
          compression-level: 0
 
#     - name: Create release
#        uses: softprops/action-gh-release@v2
#       with:
#         tag_name: ${{ steps.build.outputs.filename }}
#          name: "Turnip ${{ steps.build.outputs.version }} - ${{ inputs.build_variant || 'optimized' }}"
#          body: |
            ## Turnip Vulkan Driver for Adreno 7xx
            
#            **Mesa Version:** ${{ steps.build.outputs.version }}
#            **Vulkan Version:** ${{ steps.build.outputs.vulkan_version }}
#            **Build Date:** ${{ steps.build.outputs.build_date }}
#            **Build Variant:** ${{ inputs.build_variant || 'optimized' }}
            
            ### Supported GPUs
#            - Adreno 710/720/730/740/750
            
            ### Features
#            - Vulkan 1.4.x support
#            - Timeline Semaphore optimization (DXVK 2.4+)
#            - UBWC 5/6 support
#            - VKD3D-Proton v3.0b compatible
            
            ### Recommended TU_DEBUG
#            ```
#            TU_DEBUG=noconform
#           ``` 
            ### Troubleshooting
#            - Black screen: TU_DEBUG=deck_emu
#            - Graphics glitches: TU_DEBUG=sysmem,nolrz
            
          files: build/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
