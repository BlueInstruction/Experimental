name: turnip driver builder

on:
  workflow_dispatch:
    inputs:
      mesa_source:
        type: choice
        description: "mesa source"
        default: "latest_release"
        options:
          - latest_release
          - staging_branch
          - main_branch
          - custom_tag
      
      staging_branch:
        type: choice
        description: "staging branch"
        default: "staging/26"
        options:
          - staging/26
          - staging/25
      
      custom_tag:
        description: "custom tag"
        required: false
        default: ""
      
      build_type:
        type: choice
        description: "build type"
        default: "release"
        options:
          - release
          - debug
          
  schedule:  
    - cron: "0 7 * * *"

permissions:
  contents: write

env:
  NDK_VERSION: "android-ndk-r29"
  API_LEVEL: "35"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: checkout repository
        uses: actions/checkout@v4

      - name: setup build environment
        run: |
          sudo sed -i 's/^Types: deb$/Types: deb deb-src/' /etc/apt/sources.list.d/ubuntu.sources 2>/dev/null || true
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git curl unzip zip \
            python3 python3-pip python3-mako \
            ninja-build ccache patchelf \
            flex bison \
            glslang-tools \
            clang lld
          pip install --quiet meson mako pyyaml

      - name: cache ndk
        id: cache-ndk
        uses: actions/cache@v4
        with:
          path: /opt/android-ndk
          key: ${{ env.NDK_VERSION }}

      - name: setup ndk
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          curl -sL "https://dl.google.com/android/repository/${{ env.NDK_VERSION }}-linux.zip" -o ndk.zip
          sudo unzip -q ndk.zip -d /opt
          sudo mv /opt/${{ env.NDK_VERSION }} /opt/android-ndk

      - name: build turnip
        id: build
        run: |
          chmod +x turnip-driver.sh
          export MESA_SOURCE="${{ inputs.mesa_source || 'latest_release' }}"
          export STAGING_BRANCH="${{ inputs.staging_branch || 'staging/26.0' }}"
          export CUSTOM_TAG="${{ inputs.custom_tag || '' }}"
          export BUILD_TYPE="${{ inputs.build_type || 'release' }}"
          export NDK_PATH="/opt/android-ndk"
          export API_LEVEL="${{ env.API_LEVEL }}"
          
          bash turnip-driver.sh
          
          echo "version=$(cat build/version.txt)" >> $GITHUB_OUTPUT
          echo "filename=$(cat build/filename.txt)" >> $GITHUB_OUTPUT
          echo "vulkan_version=$(cat build/vulkan_version.txt)" >> $GITHUB_OUTPUT
          echo "build_date=$(cat build/build_date.txt)" >> $GITHUB_OUTPUT

      - name: upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.filename }}
          path: build/*.zip
          retention-days: 30

#      - name: create release
#        uses: softprops/action-gh-release@v2
#        with:
#          tag_name: ${{ steps.build.outputs.filename }}
#          name: ${{ steps.build.outputs.filename }}
#          body: |
            ## Mesa Turnip Driver
            
#           **Mesa Version:** ${{ steps.build.outputs.version }}
#            **Vulkan Version:** ${{ steps.build.outputs.vulkan_version }}
#            **Build Date:** ${{ steps.build.outputs.build_date }}
           
          files: build/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
