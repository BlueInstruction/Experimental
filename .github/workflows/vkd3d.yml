name: Build VKD3D-Proton for Winlator

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-vkd3d:
    runs-on: ubuntu-24.04
    steps:
      - name: Clone, Build and Package
        uses: Joshua-Ashton/arch-mingw-github-action@v8
        with:
          command: |
            sudo pacman -S --noconfirm zip
            
            LATEST_TAG=$(curl -s https://api.github.com/repos/HansKristian-Work/vkd3d-proton/releases/latest | grep '"tag_name"' | cut -d'"' -f4)
            
            git clone --recursive --branch "$LATEST_TAG" https://github.com/HansKristian-Work/vkd3d-proton.git
            cd vkd3d-proton
            
            # Build without strip for full size
            ./package-release.sh "$LATEST_TAG" build --no-package --dev-build
            
            VERSION=$(echo "$LATEST_TAG" | sed 's/^v//')
            SHA=$(git rev-parse --short HEAD)
            BUILD_DIR=$(find build -maxdepth 1 -type d -name "vkd3d-proton-*" | head -1)
            VERSION_CODE=$((RANDOM % 3))
            
            mkdir -p /tmp/pkg/system32
            mkdir -p /tmp/pkg/syswow64
            
            cp "$BUILD_DIR/x64/"*.dll /tmp/pkg/system32/
            cp "$BUILD_DIR/x86/"*.dll /tmp/pkg/syswow64/
            
            cat > /tmp/pkg/profile.json << EOF
            {
              "type": "VKD3D",
              "versionName": "${VERSION}-${SHA}",
              "versionCode": ${VERSION_CODE},
              "description": "vkd3d-proton",
              "files": [
                {
                  "source": "system32/d3d12.dll",
                  "target": "\${system32}/d3d12.dll"
                },
                {
                  "source": "system32/d3d12core.dll",
                  "target": "\${system32}/d3d12core.dll"
                },
                {
                  "source": "syswow64/d3d12.dll",
                  "target": "\${syswow64}/d3d12.dll"
                },
                {
                  "source": "syswow64/d3d12core.dll",
                  "target": "\${syswow64}/d3d12core.dll"
                }
              ]
            }
            EOF
            
            cd /tmp/pkg
            zip -r "/github/workspace/vkd3d-proton-${VERSION}-${SHA}.wcp" .
            
            echo "VERSION=${VERSION}" >> /github/workspace/build.env
            echo "SHA=${SHA}" >> /github/workspace/build.env

      - name: Load build info
        run: |
          cat build.env >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: vkd3d-${{ env.VERSION }}-${{ github.run_number }}
          name: VKD3D-Proton ${{ env.VERSION }}
          files: "*.wcp"
          body: |
            VKD3D-Proton build for Winlator
            Version: ${{ env.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
