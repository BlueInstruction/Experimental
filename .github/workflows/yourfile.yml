name: Turnip Builder Simple - Fixed

on:
  workflow_dispatch:
    inputs:
      mesa_branch:
        description: 'Mesa branch/tag'
        required: false
        default: 'main'
        type: string
      target_device:
        description: 'Target Device'
        required: false
        default: 'adreno-750'
        type: choice
        options: [adreno-730, adreno-740, adreno-750, generic-a6xx]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y meson ninja-build python3-pip python3-mako python3-setuptools \
            flex bison patchelf curl unzip clang lld llvm libclang-dev pkg-config jq

      - name: Setup Python Tools
        run: |
          # Removed --break-system-packages as it is not needed/supported on this runner version
          pip3 install --upgrade meson mako

      - name: Setup NDK
        run: |
          curl -L -o ndk.zip "https://dl.google.com/android/repository/android-ndk-r26d-linux.zip"
          unzip -q ndk.zip
          echo "NDK_PATH=$PWD/android-ndk-r26d" >> $GITHUB_ENV

      - name: Clone Mesa
        run: |
          git clone --depth 1 --branch ${{ github.event.inputs.mesa_branch }} https://gitlab.freedesktop.org/mesa/mesa.git mesa-source
          cd mesa-source
          echo "MESA_COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Configure and Build
        run: |
          cd mesa-source
          
          # Create Cross File
          cat > android_cross.ini << EOF
          [binaries]
          c = '$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang'
          cpp = '$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang++'
          ar = '$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar'
          strip = '$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip'
          ld = 'lld'
          [host_machine]
          system = 'android'
          cpu_family = 'aarch64'
          cpu = 'armv8'
          endian = 'little'
          EOF
          
          DEVICE="${{ github.event.inputs.target_device }}"
          KMD="kgsl"
          if [ "$DEVICE" = "adreno-750" ]; then KMD="msm,kgsl"; fi
          
          meson setup build-android --cross-file android_cross.ini -Dplatforms=android -Dvulkan-drivers=freedreno -Dfreedreno-kmds=$KMD -Dbuildtype=release
          ninja -C build-android src/freedreno/vulkan/libvulkan_freedreno.so

      - name: Upload Final Driver
        uses: actions/upload-artifact@v4
        with:
          name: turnip-${{ github.event.inputs.target_device }}-${{ env.MESA_COMMIT }}
          path: mesa-source/build-android/src/freedreno/vulkan/libvulkan_freedreno.so

